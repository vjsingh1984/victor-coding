# Copyright 2025 Vijaykumar Singh <singhvjd@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Bug Fix Workflows for Coding Vertical
# =====================================
# Multi-step workflows for investigating and fixing bugs
# with systematic debugging and verification.

workflows:
  # ===========================================================================
  # Full Bug Fix Workflow
  # ===========================================================================
  bug_fix:
    description: "Systematic bug investigation and fix with verification"

    metadata:
      version: "1.0"
      author: "victor"
      vertical: coding
      category: debugging
      complexity: medium

    nodes:
      # =====================================================================
      # Stage 1: Investigate Bug
      # =====================================================================
      - id: investigate
        type: agent
        name: "Investigate Bug"
        role: researcher
        goal: |
          Investigate the bug root cause through systematic analysis:
          1. Understand the bug report/description
          2. Locate relevant code paths
          3. Check recent changes that might have caused the bug
          4. Identify error patterns in logs or stack traces
          5. Find related test cases that might be failing
          6. Document the investigation findings
        tool_budget: 25
        tools: [read, grep, code_search, shell, git, refs, symbol]
        llm_config:
          temperature: 0.2
        output: investigation
        next: [diagnose]

      # =====================================================================
      # Stage 2: Diagnose and Plan Fix
      # =====================================================================
      - id: diagnose
        type: agent
        name: "Diagnose Issue"
        role: planner
        goal: |
          Based on the investigation, diagnose the exact issue:
          1. Identify the root cause of the bug
          2. Determine all affected code locations
          3. Plan the minimal fix required
          4. Consider potential side effects
          5. Identify test cases that need to pass
        tool_budget: 15
        tools: [read, grep]
        llm_config:
          temperature: 0.3
        input_mapping:
          findings: investigation
        output: fix_plan
        next: [approve_fix]

      - id: approve_fix
        type: hitl
        name: "Approve Fix Plan"
        hitl_type: approval
        prompt: |
          ## Bug Fix Plan

          **Investigation Summary:**
          {investigation}

          **Proposed Fix:**
          {fix_plan}

          Do you approve this fix plan?
        context_keys:
          - investigation
          - fix_plan
        timeout: 300
        fallback: continue
        next: [apply_fix]

      # =====================================================================
      # Stage 3: Apply Fix
      # =====================================================================
      - id: apply_fix
        type: agent
        name: "Apply Bug Fix"
        role: executor
        goal: |
          Apply the bug fix according to the diagnosis:
          1. Make the minimum necessary code changes
          2. Follow existing code style and patterns
          3. Add or update comments as needed
          4. Ensure changes are focused on the bug
        tool_budget: 25
        tools: [read, edit, write, shell]
        llm_config:
          temperature: 0.1
        input_mapping:
          plan: fix_plan
          investigation: investigation
        output: fix_result
        next: [run_tests]

      # =====================================================================
      # Stage 4: Verify Fix
      # =====================================================================
      - id: run_tests
        type: compute
        name: "Run Tests"
        handler: test_runner
        tools: [shell]
        inputs:
          test_command: $ctx.test_command
          timeout: 180
        output: test_results
        constraints:
          llm_allowed: false
          timeout: 180
        next: [check_tests]

      - id: check_tests
        type: condition
        name: "Check Test Results"
        condition: "tests_passing"
        branches:
          "passing": check_quality
          "failing": analyze_failure
          "no_tests": check_quality

      - id: analyze_failure
        type: agent
        name: "Analyze Test Failures"
        role: analyst
        goal: |
          Analyze why tests are still failing:
          1. Identify which tests failed
          2. Understand the failure reasons
          3. Determine if fix was incomplete
          4. Plan additional changes needed
        tool_budget: 15
        tools: [read, grep]
        llm_config:
          temperature: 0.2
        output: failure_analysis
        next: [should_retry]

      - id: should_retry
        type: condition
        name: "Should Retry Fix"
        condition: "should_continue_fixing"
        branches:
          "continue_fixing": apply_fix
          "escalate": escalate_to_human
          "submit_best_effort": check_quality

      - id: escalate_to_human
        type: hitl
        name: "Escalate to Human"
        hitl_type: input
        prompt: |
          ## Fix Attempt Failed

          **Original Bug:**
          {investigation}

          **Fix Attempted:**
          {fix_result}

          **Test Failures:**
          {failure_analysis}

          Please provide guidance on how to proceed.
        context_keys:
          - investigation
          - fix_result
          - failure_analysis
        timeout: 600
        fallback: continue
        next: [apply_fix]

      # =====================================================================
      # Stage 5: Quality Check
      # =====================================================================
      - id: check_quality
        type: compute
        name: "Check Code Quality"
        handler: code_validation
        tools: [shell]
        inputs:
          check_lint: true
          check_types: true
        output: quality_results
        constraints:
          llm_allowed: false
          timeout: 120
        next: [assess_quality]

      - id: assess_quality
        type: condition
        name: "Assess Quality"
        condition: "code_quality_check"
        branches:
          "excellent": commit_fix
          "good": commit_fix
          "acceptable": commit_fix
          "needs_improvement": improve_quality

      - id: improve_quality
        type: agent
        name: "Improve Code Quality"
        role: executor
        goal: |
          Address code quality issues:
          1. Fix linting errors
          2. Resolve type errors
          3. Improve code formatting
        tool_budget: 15
        tools: [read, edit, shell]
        llm_config:
          temperature: 0.1
        output: quality_improvements
        next: [commit_fix]

      # =====================================================================
      # Stage 6: Commit
      # =====================================================================
      - id: commit_fix
        type: agent
        name: "Commit Bug Fix"
        role: executor
        goal: |
          Commit the bug fix with a descriptive message:
          1. Review all changes made
          2. Stage relevant files
          3. Create a commit with clear description
          4. Reference bug ID if available
        tool_budget: 10
        tools: [git, shell]
        llm_config:
          temperature: 0.1
        output: commit_result
        next: [complete]

      - id: complete
        type: transform
        name: "Mark Complete"
        transform: |
          status = "completed"
          success = true


  # ===========================================================================
  # Quick Fix Workflow (for simple bugs)
  # ===========================================================================
  quick_fix:
    description: "Quick bug fix for simple, obvious issues"

    metadata:
      version: "1.0"
      vertical: coding
      category: debugging
      complexity: low

    nodes:
      - id: locate_bug
        type: agent
        name: "Locate Bug"
        role: researcher
        goal: |
          Quickly locate the bug in the code:
          1. Find the relevant file and location
          2. Identify the issue
        tool_budget: 10
        tools: [read, grep, code_search]
        llm_config:
          temperature: 0.2
        output: bug_location
        next: [fix_bug]

      - id: fix_bug
        type: agent
        name: "Fix Bug"
        role: executor
        goal: |
          Apply the fix directly:
          1. Make the minimal change
          2. Keep it simple
        tool_budget: 15
        tools: [read, edit, shell]
        llm_config:
          temperature: 0.1
        input_mapping:
          location: bug_location
        output: fix_result
        next: [verify_fix]

      - id: verify_fix
        type: compute
        name: "Verify Fix"
        handler: test_runner
        tools: [shell]
        inputs:
          test_command: $ctx.test_command
          timeout: 120
        output: test_results
        constraints:
          llm_allowed: false
          timeout: 120
        next: [done]

      - id: done
        type: transform
        name: "Complete"
        transform: |
          status = "completed"
          success = test_results.get("failed", 0) == 0


  # ===========================================================================
  # Debug Investigation Workflow (deep investigation only)
  # ===========================================================================
  debug_investigation:
    description: "Deep investigation workflow for complex bugs"

    metadata:
      version: "1.0"
      vertical: coding
      category: debugging
      complexity: high

    nodes:
      - id: gather_context
        type: agent
        name: "Gather Context"
        role: researcher
        goal: |
          Gather comprehensive context about the bug:
          1. Collect all error messages and stack traces
          2. Find related logs and outputs
          3. Identify when the bug started appearing
          4. Check if it's environment-specific
        tool_budget: 20
        tools: [read, grep, shell, git]
        llm_config:
          temperature: 0.2
        output: context
        next: [trace_execution]

      - id: trace_execution
        type: agent
        name: "Trace Execution Path"
        role: researcher
        goal: |
          Trace the code execution path:
          1. Identify the entry point
          2. Follow the code flow
          3. Find where behavior diverges from expected
          4. Document the execution trace
        tool_budget: 30
        tools: [read, grep, code_search, refs, symbol]
        llm_config:
          temperature: 0.2
        input_mapping:
          context: context
        output: execution_trace
        next: [identify_cause]

      - id: identify_cause
        type: agent
        name: "Identify Root Cause"
        role: analyst
        goal: |
          Identify the root cause of the bug:
          1. Analyze the execution trace
          2. Compare with expected behavior
          3. Identify the exact point of failure
          4. Document the root cause
        tool_budget: 15
        tools: [read]
        llm_config:
          temperature: 0.3
        input_mapping:
          context: context
          trace: execution_trace
        output: root_cause
        next: [propose_fixes]

      - id: propose_fixes
        type: agent
        name: "Propose Fixes"
        role: planner
        goal: |
          Propose potential fixes for the bug:
          1. List multiple fix options
          2. Evaluate pros/cons of each
          3. Recommend the best approach
          4. Identify potential risks
        tool_budget: 10
        tools: [read]
        llm_config:
          temperature: 0.4
        input_mapping:
          root_cause: root_cause
        output: fix_proposals
        next: [complete]

      - id: complete
        type: transform
        name: "Complete Investigation"
        transform: |
          status = "completed"
          investigation_complete = true
